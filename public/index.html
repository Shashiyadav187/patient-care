<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Patient Care Monitoring System</title>
        <!-- Not present in the tutorial. Just for basic styling. -->
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
        <link rel="stylesheet" href="css/base.css"/>
        <link rel="stylesheet" href="https://bootswatch.com/cosmo/bootstrap.min.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.1/react-bootstrap.min.js"></script>
        <script>
            // Import Bootstrap components used
            var Panel = ReactBootstrap.Panel;
            var Modal = ReactBootstrap.Modal;
            var ModalBody = ReactBootstrap.ModalBody;
            var ModalDialog = ReactBootstrap.ModalDialog;
            var ModalFooter = ReactBootstrap.ModalFooter;
            var ModalHeader = ReactBootstrap.ModalHeader;
            var ModalTitle = ReactBootstrap.ModalTitle;
            var Popover = ReactBootstrap.Popover;
            var Tooltip = ReactBootstrap.Tooltip;
            var Button = ReactBootstrap.Button;
            var OverlayTrigger = ReactBootstrap.OverlayTrigger;
            var Input = ReactBootstrap.Input;
            var ButtonInput = ReactBootstrap.ButtonInput;
            var Glyphicon = ReactBootstrap.Glyphicon;
        </script>
    </head>
    <body>
        <div id="content"></div>
        <script type="text/babel">
            var Constants = {
                apiUrl: "https://patient-care-rest.herokuapp.com/api"
            }
            
            // tutorial7.js
            var Patient = React.createClass({
                getInitialState: function() {
                    return {
                        caretakerFirstName: '',
                        caretakerLastName: '',
                        prescriptions: []
                    };
                },

                componentDidMount: function() {
                    var caretakerEndpoint = Constants["apiUrl"] + "/caretakers/" + this.props.caretaker_assigned;
                    $.get(caretakerEndpoint, function(result) {
                        if (this.isMounted()) {
                            this.setState({
                                caretakerFirstName: result.first_name,
                                caretakerLastName: result.last_name
                            });
                        }
                    }.bind(this));
                },

                rawMarkup: function() {
                    var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
                    return { __html: rawMarkup };
                },

                medTaken: function() {
                    return this.props.medication_taken ? "Taken" : "Not Taken";
                },

                getPrescription: function() {
                    return this.props.medication_taken ? "Taken" : "Not Taken";
                },

                render: function() {
                    return (
                        <div className="patient">
                            <h4 className="patientName">
                                <Glyphicon glyph="user" /> Name: {this.props.first_name} {this.props.last_name}
                            </h4>
                            <h4 className="patientAge">
                                <Glyphicon glyph="hourglass" /> Age: {this.props.age}
                            </h4>
                            <h4 className="patientPhone">
                                <Glyphicon glyph="earphone" /> Phone: {this.props.phone}
                            </h4>
                            <h4 className="patientCaretakerAssigned">
                                <Glyphicon glyph="eye-open" /> Assigned Caretaker: {this.state.caretakerFirstName} {this.state.caretakerLastName}
                            </h4>
                            <h4 className="patientMedicationTaken">
                                Medication Status: {this.medTaken()}
                            </h4>
                            <span dangerouslySetInnerHTML={this.rawMarkup()} />
                        </div>
                    );
                }
            });

            // tutorial10.js
            var PatientList = React.createClass({
                render: function() {
                    var patientNodes = this.props.data.map(function (patient) {
                        return (
                            <div key={patient}>
                                <Patient first_name={patient.first_name} last_name={patient.last_name} age={patient.age} phone={patient.phone} medication_taken={patient.medication_taken} caretaker_assigned={patient.caretaker_assigned}>
                                    {/*TODO: strange behaviour: this needs to be removed, but if it is, causes several exceptions,
                                    could be due to lack of unique key prop*/}
                                    {patient.prescription_assigned}
                                </Patient>
                                <AddPrescriptionModal />
                                <PrescriptionList key={patient} data={patient.prescription_assigned}/>
                            </div>
                        );
                    });
                    return (
                        <div className="patientList">
                            {patientNodes}
                        </div>
                    );
                }
            });

            // tutorial18.js
            var PatientForm = React.createClass({
                handleSubmit: function(e) {
                    e.preventDefault();
                    var author = this.refs.author.value.trim();
                    var text = this.refs.text.value.trim();
                    if (!text || !author) {
                        return;
                    }
                    this.props.onPatientSubmit({first_name: first_name, last_name: last_name, age: age});
                    this.refs.first_name.value = '';
                    this.refs.last_name.value = '';
                    return;
                },
                render: function() {
                    return (
                        <form className="patientForm" onSubmit={this.handleSubmit}>
                            <input type="text" placeholder="Patient First Name" ref="first_name" />
                            <input type="text" placeholder="Patient Last Name" ref="last_name" />
                            <input type="text" placeholder="Patient Age" ref="age" />
                            <input type="submit" value="Post" />
                        </form>
                    );
                }
            });

            // tutorial20.js
            var PatientBox = React.createClass({
                loadPatientsFromServer: function() {
                    $.ajax({
                        url: this.props.apiUrl + "/patients",
                        dataType: 'json',
                        cache: false,
                        success: function(data) {
                            this.setState({data: data});
                        }.bind(this),
                        error: function(xhr, status, err) {
                            console.error(url, status, err.toString());
                        }.bind(this)
                    });
                },
                handlePatientSubmit: function(patient) {
                    var patients = this.state.data;
                    var newPatients = patients.concat([patient]);
                    this.setState({data: newPatients});
                    $.ajax({
                        url: this.props.apiUrl + "/patients",
                        dataType: 'json',
                        type: 'POST',
                        data: patient,
                        success: function(data) {
                            this.setState({data: data});
                        }.bind(this),
                        error: function(xhr, status, err) {
                            console.error(url, status, err.toString());
                        }.bind(this)
                    });
                },
                getInitialState: function() {
                    return {data: []};
                },
                componentDidMount: function() {
                    this.loadPatientsFromServer();
                    setInterval(this.loadPatientsFromServer, this.props.pollInterval);
                },
                render: function() {
                    return (
                        <div className="patientBox">
                            <h1>Patients</h1>
                            <PatientList data={this.state.data}/>
                            <PatientForm onPatientSubmit={this.handlePatientSubmit} />
                        </div>
                    );
                }
            });

            var Prescription = React.createClass({
                getInitialState: function() {
                    return {
                        instructions: '',
                        medication_assigned: [],
                        alert_assigned: []
                    };
                },

                componentDidMount: function() {
                    var prescriptionEndpoint = Constants["apiUrl"] + "/prescriptions/" + this.props.data;
                    $.get(prescriptionEndpoint, function(result) {
                        if (this.isMounted()) {
                            this.setState({
                                instructions: result.instructions,
                                alert_assigned: result.alert_assigned
                            });
                            var medicationEndpoint = Constants["apiUrl"] + "/medications/" + result.medication_assigned
                            $.get(medicationEndpoint, function(result) {
                                if (this.isMounted()) {
                                    this.setState({
                                        medicationName: result.name
                                    });
                                }
                            }.bind(this));
                        }
                    }.bind(this));
                },

                rawMarkup: function() {
                    var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
                    return { __html: rawMarkup };
                },

                render: function() {
                    return (
                        <div class="medication">
                        <Panel bsStyle="primary" header={<h3 class="medicationHeader">Assigned Medication: {this.state.medicationName}</h3>}>
                                <h4>Instructions:</h4>
                                <div className="instructions">
                                    {this.state.instructions}
                                </div>
                            <AlertList data={this.state.alert_assigned}></AlertList>
                        </Panel>
                        </div>
                    );
                }
            });

            var PrescriptionList = React.createClass({
                render: function() {

                var prescriptionNodes = this.props.data.map(function (prescription) {
                        return (
                            <Prescription key={prescription} data={prescription}>
                            </Prescription>
                        );
                    });

                    return (
                        <div className="prescriptionList">
                            {prescriptionNodes}
                        </div>
                    );
                }
            });

            var Alert = React.createClass({
                getInitialState: function() {
                    return {
                        hour: 0,
                        timeout: 0,
                        schedule: {} 
                    };
                },

                componentDidMount: function() {
                    var alertEndpoint = Constants["apiUrl"] + "/alerts/" + this.props.data;
                    $.get(alertEndpoint, function(result) {
                        if (this.isMounted()) {
                            this.setState({
                                hour: result.hour,
                                timeout: result.timeout,
                                schedule: result.schedule
                            });
                        }
                    }.bind(this));
                },

                rawMarkup: function() {
                    var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
                    return { __html: rawMarkup };
                },

                getTime: function(hour) {
                    if (hour <= 11)
                        return hour + " AM";
                    else if (hour == 12)
                        return hour + " PM";
                    else
                        return hour-12 + " PM";
                },

                getSchedule: function(schedule) {
                    var days = "";
                    for (var day in schedule) {
                        if (schedule[day])
                            days += day + ", ";
                    }
                    return days.substring(0, days.length - 2);
                },

                render: function() {
                    return (
                        <div class="alert">
                            <Panel bsStyle="primary" header="Scheduled Alert:">
                                <h5 className="alertSchedule">
                                    {this.getSchedule(this.state.schedule)} at {this.getTime(this.state.hour)}
                                </h5>
                                <h5 className="alertTimeout">
                                    Alert Timeout: {this.state.timeout} minutes
                                </h5>
                            </Panel>
                        </div>
                    );
                }
            });

            var AlertList = React.createClass({
                render: function() {
                    var alertNodes = this.props.data.map(function (alert) {
                        return (
                            <Alert key={alert} data={alert}>
                            </Alert>
                        );
                    });

                    return (
                        <div className="alertList">
                            {alertNodes}
                        </div>
                    );
                }
            });

            var AddPrescriptionModal = React.createClass({

              getInitialState() {
                return { showModal: false };
              },

              close() {
                this.setState({ showModal: false });
              },

              open() {
                this.setState({ showModal: true });
              },

              render() {
                let popover = <Popover title="popover">very popover. such engagement</Popover>;
                let resetTooltip = <Tooltip>Reset all the fields of this prescription.</Tooltip>;
                let submitTooltip = <Tooltip>Submit this prescription for the patient.</Tooltip>;
                let cancelTooltip = <Tooltip>Cancel this prescription and discard all fields.</Tooltip>;

                return (
                  <div>
                    <Button
                      bsStyle="primary"
                      bsSize="medium"
                      className="addPrescriptionBtn"
                      onClick={this.open}
                    >
                    <Glyphicon glyph="plus" className="addPrescriptionGlyph"/>   Add Prescription
                    </Button>

                    <Modal show={this.state.showModal} onHide={this.close}>
                      <Modal.Header closeButton>
                        <Modal.Title>Add Prescription</Modal.Title>
                      </Modal.Header>
                      <Modal.Body>
                        <form>
                        <Input type="text" label="Medication Name" placeholder="Enter medication name" />
                        <Input type="textarea" label="Instructions" placeholder="Enter dosage instructions" />
                        <Input label="Schedule" help="Select the days the medication should be taken on" />
                        <Input type="checkbox" label="Monday"/>
                        <Input type="checkbox" label="Tuesday"/>
                        <Input type="checkbox" label="Wednesday"/>
                        <Input type="checkbox" label="Thursday"/>
                        <Input type="checkbox" label="Friday"/>
                        <Input type="checkbox" label="Saturday"/>
                        <Input type="checkbox" label="Sunday"/>
                        <Input type="select" help="Select the time the medication should be taken at">
                          <option value="select">6 AM</option>
                          <option value="other">7 AM</option>
                          <option value="other">8 AM</option>
                          <option value="other">9 AM</option>
                          <option value="other">10 AM</option>
                          <option value="other">11 AM</option>
                          <option value="other">12 PM</option>
                          <option value="other">1 PM</option>
                          <option value="other">2 PM</option>
                          <option value="other">3 PM</option>
                          <option value="other">4 PM</option>
                          <option value="other">5 PM</option>
                          <option value="other">6 PM</option>
                          <option value="other">7 PM</option>
                          <option value="other">8 PM</option>
                          <option value="other">9 PM</option>
                          <option value="other">10 PM</option>
                          <option value="other">11 PM</option>
                          <option value="other">12 AM</option>
                        </Input>
                        
                        <OverlayTrigger overlay={resetTooltip} placement="left">
                            <ButtonInput type="reset" value="Reset Prescription" />
                        </OverlayTrigger>
                        <OverlayTrigger overlay={submitTooltip} placement="left">
                            <ButtonInput type="submit" value="Enter Prescription" />
                        </OverlayTrigger>
                        </form>
                      </Modal.Body>
                      <Modal.Footer>
                        <OverlayTrigger overlay={cancelTooltip} placement="right">
                            <Button onClick={this.close}>Cancel Prescription</Button>
                        </OverlayTrigger>
                      </Modal.Footer>
                    </Modal>
                  </div>
                );
              }
            });

            ReactDOM.render(
                <PatientBox apiUrl="https://patient-care-rest.herokuapp.com/api" pollInterval={2000} />,
                document.getElementById('content')
            );

        </script>
    </body>
</html>
